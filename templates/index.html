<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM å¯¹è¯åŠ©æ‰‹</title>
    <!-- Marked.js for Markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github-dark.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/highlight.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            height: 100vh;
            display: flex;
            background: #f5f5f5;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 260px;
            background: #202123;
            color: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #444;
        }

        .sidebar-header {
            padding: 16px;
            border-bottom: 1px solid #444;
        }

        .new-chat-btn {
            width: 100%;
            padding: 12px;
            background: #343541;
            color: white;
            border: 1px solid #565869;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .new-chat-btn:hover {
            background: #40414f;
        }

        .session-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
        }

        .session-item {
            padding: 12px;
            margin-bottom: 4px;
            background: #343541;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
        }

        .session-item:hover {
            background: #40414f;
        }

        .session-item.active {
            background: #40414f;
            border-left: 3px solid #19c37d;
        }

        .session-title {
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            cursor: pointer;
        }

        .session-title:hover {
            text-decoration: underline;
        }

        .session-title.editing {
            background: #2a2b32;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #19c37d;
            outline: none;
            white-space: normal;
            overflow: visible;
            text-overflow: clip;
        }

        .session-actions {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .session-item:hover .session-actions {
            opacity: 1;
        }

        .session-action-btn {
            background: transparent;
            border: none;
            color: #8e8ea0;
            font-size: 16px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .session-action-btn:hover {
            background: #565869;
            color: white;
        }

        .session-delete {
            color: #8e8ea0;
            font-size: 18px;
            cursor: pointer;
            padding: 0 8px;
            transition: color 0.2s;
        }

        .session-delete:hover {
            color: #ff4444;
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .chat-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e5e5e5;
            background: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-title-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .chat-title {
            font-size: 18px;
            font-weight: 600;
            color: #202123;
        }

        .model-selector {
            padding: 6px 12px;
            background: #f7f7f8;
            border: 1px solid #d9d9e3;
            border-radius: 6px;
            font-size: 13px;
            color: #565869;
            cursor: pointer;
            outline: none;
            transition: all 0.2s;
        }

        .model-selector:hover {
            background: #ececf1;
            border-color: #19c37d;
        }

        .model-selector:focus {
            border-color: #19c37d;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .clear-btn {
            padding: 8px 16px;
            background: #f7f7f8;
            border: 1px solid #d9d9e3;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            color: #565869;
            transition: background 0.2s;
        }

        .clear-btn:hover {
            background: #ececf1;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #fafafa;
        }

        .message {
            margin-bottom: 24px;
            display: flex;
            gap: 16px;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
        }

        .message-content-wrapper {
            max-width: 75%;
            display: flex;
            flex-direction: column;
        }

        .message-content {
            padding: 16px 20px;
            border-radius: 12px;
            line-height: 1.8;
            word-wrap: break-word;
            font-size: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.assistant .message-content {
            background: white;
            color: #1a1a1a;
            border: 1px solid #e5e5e5;
        }

        /* Markdownæ ·å¼ */
        .message-content h1,
        .message-content h2,
        .message-content h3,
        .message-content h4,
        .message-content h5,
        .message-content h6 {
            margin-top: 16px;
            margin-bottom: 8px;
            font-weight: 600;
            line-height: 1.4;
        }

        .message-content h1 { font-size: 1.8em; }
        .message-content h2 { font-size: 1.5em; }
        .message-content h3 { font-size: 1.3em; }

        .message-content p {
            margin-bottom: 12px;
        }

        .message-content ul,
        .message-content ol {
            margin-left: 24px;
            margin-bottom: 12px;
        }

        .message-content li {
            margin-bottom: 6px;
        }

        .message-content blockquote {
            border-left: 4px solid #19c37d;
            padding-left: 16px;
            margin: 12px 0;
            color: #666;
            font-style: italic;
        }

        .message-content code {
            background: #f4f4f5;
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            color: #e83e8c;
        }

        .message.user .message-content code {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .message-content pre {
            background: #1e1e1e;
            padding: 16px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 12px 0;
            position: relative;
        }

        .code-block-wrapper {
            margin: 12px 0;
        }

        .code-block-wrapper pre {
            margin: 0;
            border-radius: 0 0 8px 8px;
        }

        .message-content pre code {
            background: transparent;
            padding: 0;
            color: #d4d4d4;
            font-size: 14px;
            line-height: 1.6;
        }

        .code-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 16px;
            background: #2d2d2d;
            border-radius: 8px 8px 0 0;
        }

        .code-language {
            color: #888;
            font-size: 12px;
            font-family: 'Consolas', 'Monaco', monospace;
            text-transform: uppercase;
        }

        .copy-btn {
            background: #444;
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .copy-btn:hover {
            background: #19c37d;
        }

        .message-content table {
            border-collapse: collapse;
            width: 100%;
            margin: 12px 0;
        }

        .message-content th,
        .message-content td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }

        .message-content th {
            background: #f7f7f8;
            font-weight: 600;
        }

        .message-content a {
            color: #19c37d;
            text-decoration: none;
            border-bottom: 1px solid transparent;
            transition: border-color 0.2s;
        }

        .message-content a:hover {
            border-bottom-color: #19c37d;
        }

        .message-time {
            font-size: 11px;
            color: #8e8ea0;
            margin-top: 6px;
            padding-left: 4px;
        }

        /* è¾“å…¥åŒº */
        .input-container {
            padding: 20px;
            border-top: 1px solid #e5e5e5;
            background: white;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        .input-wrapper {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-width: 900px;
            margin: 0 auto;
        }

        .input-row {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-field-wrapper {
            flex: 1;
            position: relative;
        }

        .message-input {
            width: 100%;
            min-height: 50px;
            max-height: 300px;
            padding: 14px 16px;
            padding-right: 60px;
            border: 2px solid #e5e5e5;
            border-radius: 12px;
            font-size: 15px;
            line-height: 1.6;
            resize: none;
            font-family: inherit;
            outline: none;
            transition: all 0.2s;
            overflow-y: auto;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
        }

        .message-input:focus {
            border-color: #19c37d;
            box-shadow: 0 0 0 3px rgba(25, 195, 125, 0.1);
        }

        .message-input::-webkit-scrollbar {
            width: 6px;
        }

        .message-input::-webkit-scrollbar-track {
            background: transparent;
        }

        .message-input::-webkit-scrollbar-thumb {
            background: #d9d9e3;
            border-radius: 3px;
        }

        .message-input::-webkit-scrollbar-thumb:hover {
            background: #19c37d;
        }

        .input-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: #8e8ea0;
            padding: 0 4px;
            min-height: 18px;
        }

        .char-counter {
            opacity: 0;
            transition: opacity 0.2s;
        }

        .message-input:focus ~ .input-meta .char-counter,
        .char-counter.show {
            opacity: 1;
        }

        .char-counter.warning {
            color: #f5a623;
        }

        .char-counter.error {
            color: #e74c3c;
        }

        .input-hint {
            font-style: italic;
        }

        .send-btn {
            padding: 14px 28px;
            background: linear-gradient(135deg, #19c37d 0%, #17a366 100%);
            color: white;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.2s;
            box-shadow: 0 2px 8px rgba(25, 195, 125, 0.3);
            min-width: 80px;
            align-self: flex-end;
        }

        .send-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #17a366 0%, #158f57 100%);
            box-shadow: 0 4px 12px rgba(25, 195, 125, 0.4);
            transform: translateY(-1px);
        }

        .send-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .send-btn:disabled {
            background: #d9d9e3;
            cursor: not-allowed;
        }

        /* åŠ è½½åŠ¨ç”» */
        .typing-indicator {
            display: inline-block;
        }

        .typing-indicator span {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #8e8ea0;
            border-radius: 50%;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #d9d9e3;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #c0c0c0;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #8e8ea0;
            font-size: 14px;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
    </style>
</head>
<body>
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar">
        <div class="sidebar-header">
            <button class="new-chat-btn" onclick="createNewSession()">+ æ–°å»ºå¯¹è¯</button>
        </div>
        <div class="session-list" id="sessionList"></div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content">
        <div class="chat-header">
            <div class="chat-title-section">
                <div class="chat-title" id="chatTitle">é€‰æ‹©æˆ–åˆ›å»ºä¸€ä¸ªå¯¹è¯</div>
                <select class="model-selector" id="modelSelector" onchange="changeModel()">
                    <option value="">é€‰æ‹©æ¨¡å‹...</option>
                </select>
            </div>
            <div class="header-actions">
                <button class="clear-btn" onclick="clearCurrentSession()">æ¸…ç©ºå¯¹è¯</button>
            </div>
        </div>
        <div class="messages-container" id="messagesContainer">
            <div class="empty-state">
                <div class="empty-state-icon">ğŸ’¬</div>
                <div>å¼€å§‹æ–°çš„å¯¹è¯</div>
            </div>
        </div>
        <div class="input-container">
            <div class="input-wrapper">
                <div class="input-row">
                    <div class="input-field-wrapper">
                        <textarea
                            class="message-input"
                            id="messageInput"
                            placeholder="è¾“å…¥æ¶ˆæ¯... (Shift+Enteræ¢è¡Œï¼ŒEnterå‘é€)"
                            rows="1"
                        ></textarea>
                        <div class="input-meta">
                            <span class="input-hint">æ”¯æŒMarkdownæ ¼å¼</span>
                            <span class="char-counter" id="charCounter">0 å­—ç¬¦</span>
                        </div>
                    </div>
                    <button class="send-btn" id="sendBtn" onclick="sendMessage()">å‘é€</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSessionId = null;
        let isGenerating = false;
        let availableModels = [];

        // åˆå§‹åŒ–
        async function init() {
            await loadModels();
            await loadSessions();
            setupInputHandlers();

            // æ£€æŸ¥ä¾èµ–åº“æ˜¯å¦åŠ è½½
            console.log('Marked.js loaded:', typeof marked !== 'undefined');
            console.log('Highlight.js loaded:', typeof hljs !== 'undefined');

            if (typeof marked === 'undefined') {
                console.error('Marked.js æœªåŠ è½½ï¼Markdownæ¸²æŸ“å°†ä¸å¯ç”¨ã€‚');
            }
        }

        // åŠ è½½å¯ç”¨æ¨¡å‹
        async function loadModels() {
            try {
                const response = await fetch('/api/models');
                availableModels = await response.json();

                const selector = document.getElementById('modelSelector');
                selector.innerHTML = '<option value="">é€‰æ‹©æ¨¡å‹...</option>';

                availableModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = model.name;
                    option.title = model.description;
                    selector.appendChild(option);
                });
            } catch (error) {
                console.error('åŠ è½½æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // åŠ è½½ä¼šè¯åˆ—è¡¨
        async function loadSessions() {
            try {
                const response = await fetch('/api/sessions');
                const sessions = await response.json();

                const sessionList = document.getElementById('sessionList');
                sessionList.innerHTML = '';

                if (sessions.length === 0) {
                    await createNewSession();
                    return;
                }

                sessions.forEach(session => {
                    const item = document.createElement('div');
                    item.className = 'session-item';
                    if (session.session_id === currentSessionId) {
                        item.classList.add('active');
                    }
                    item.innerHTML = `
                        <div class="session-title" ondblclick="startRenameSession('${session.session_id}', event)">${session.title}</div>
                        <div class="session-actions">
                            <button class="session-action-btn" onclick="startRenameSession('${session.session_id}', event)" title="é‡å‘½å">âœï¸</button>
                            <button class="session-action-btn" onclick="deleteSession('${session.session_id}', event)" title="åˆ é™¤">ğŸ—‘ï¸</button>
                        </div>
                    `;
                    item.onclick = (e) => {
                        // åªæœ‰ç‚¹å‡»ä¼šè¯é¡¹æœ¬èº«æ—¶æ‰åˆ‡æ¢ï¼Œä¸åŒ…æ‹¬æŒ‰é’®
                        if (!e.target.classList.contains('session-action-btn') &&
                            !e.target.classList.contains('session-title')) {
                            loadSession(session.session_id);
                        }
                    };
                    // ç‚¹å‡»æ ‡é¢˜ä¹Ÿåˆ‡æ¢ä¼šè¯
                    const titleDiv = item.querySelector('.session-title');
                    titleDiv.onclick = (e) => {
                        if (!titleDiv.classList.contains('editing')) {
                            loadSession(session.session_id);
                        }
                    };
                    sessionList.appendChild(item);
                });

                // å¦‚æœæ²¡æœ‰é€‰ä¸­çš„ä¼šè¯ï¼Œé€‰ä¸­ç¬¬ä¸€ä¸ª
                if (!currentSessionId && sessions.length > 0) {
                    loadSession(sessions[0].session_id);
                }
            } catch (error) {
                console.error('åŠ è½½ä¼šè¯åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // åˆ›å»ºæ–°ä¼šè¯
        async function createNewSession() {
            try {
                const response = await fetch('/api/sessions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title: 'æ–°å¯¹è¯' })
                });
                const session = await response.json();
                await loadSessions();
                loadSession(session.session_id);
            } catch (error) {
                console.error('åˆ›å»ºä¼šè¯å¤±è´¥:', error);
            }
        }

        // åŠ è½½æŒ‡å®šä¼šè¯
        async function loadSession(sessionId) {
            try {
                const response = await fetch(`/api/sessions/${sessionId}`);
                const session = await response.json();

                currentSessionId = sessionId;
                document.getElementById('chatTitle').textContent = session.title;

                // æ›´æ–°æ¨¡å‹é€‰æ‹©å™¨
                const modelSelector = document.getElementById('modelSelector');
                modelSelector.value = session.model || 'gpt-4o';

                const container = document.getElementById('messagesContainer');
                container.innerHTML = '';

                if (session.messages.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ’¬</div>
                            <div>å¼€å§‹æ–°çš„å¯¹è¯</div>
                        </div>
                    `;
                } else {
                    session.messages.forEach(msg => {
                        appendMessage(msg.role, msg.content, msg.timestamp);
                    });
                }

                await loadSessions(); // æ›´æ–°ä¾§è¾¹æ é«˜äº®
            } catch (error) {
                console.error('åŠ è½½ä¼šè¯å¤±è´¥:', error);
            }
        }

        // åˆ é™¤ä¼šè¯
        async function deleteSession(sessionId, event) {
            event.stopPropagation();
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå¯¹è¯å—ï¼Ÿ')) return;

            try {
                await fetch(`/api/sessions/${sessionId}`, { method: 'DELETE' });
                if (sessionId === currentSessionId) {
                    currentSessionId = null;
                }
                await loadSessions();
            } catch (error) {
                console.error('åˆ é™¤ä¼šè¯å¤±è´¥:', error);
            }
        }

        // å¼€å§‹é‡å‘½åä¼šè¯
        function startRenameSession(sessionId, event) {
            event.stopPropagation();

            // æ‰¾åˆ°ä¼šè¯é¡¹
            const sessionList = document.getElementById('sessionList');
            const items = sessionList.querySelectorAll('.session-item');

            items.forEach(item => {
                const titleDiv = item.querySelector('.session-title');
                const actionsDiv = item.querySelector('.session-actions');

                if (titleDiv.getAttribute('ondblclick').includes(sessionId)) {
                    const currentTitle = titleDiv.textContent;

                    // åˆ›å»ºè¾“å…¥æ¡†
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.value = currentTitle;
                    input.className = 'session-title editing';

                    // æ›¿æ¢æ ‡é¢˜ä¸ºè¾“å…¥æ¡†
                    titleDiv.style.display = 'none';
                    item.insertBefore(input, actionsDiv);
                    input.focus();
                    input.select();

                    // ä¿å­˜é‡å‘½å
                    const saveRename = async () => {
                        const newTitle = input.value.trim();
                        if (newTitle && newTitle !== currentTitle) {
                            try {
                                await fetch(`/api/sessions/${sessionId}/title`, {
                                    method: 'PUT',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ title: newTitle })
                                });

                                // å¦‚æœæ˜¯å½“å‰ä¼šè¯ï¼Œæ›´æ–°æ ‡é¢˜
                                if (sessionId === currentSessionId) {
                                    document.getElementById('chatTitle').textContent = newTitle;
                                }

                                await loadSessions();
                            } catch (error) {
                                console.error('é‡å‘½åå¤±è´¥:', error);
                                alert('é‡å‘½åå¤±è´¥ï¼Œè¯·é‡è¯•');
                            }
                        } else {
                            await loadSessions();
                        }
                    };

                    // Enteré”®ä¿å­˜
                    input.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            saveRename();
                        } else if (e.key === 'Escape') {
                            loadSessions();
                        }
                    });

                    // å¤±å»ç„¦ç‚¹æ—¶ä¿å­˜
                    input.addEventListener('blur', saveRename);
                }
            });
        }

        // æ¸…ç©ºå½“å‰ä¼šè¯
        async function clearCurrentSession() {
            if (!currentSessionId) return;
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºå½“å‰å¯¹è¯å—ï¼Ÿ')) return;

            try {
                await fetch(`/api/sessions/${currentSessionId}/clear`, { method: 'POST' });
                loadSession(currentSessionId);
            } catch (error) {
                console.error('æ¸…ç©ºä¼šè¯å¤±è´¥:', error);
            }
        }

        // åˆ‡æ¢æ¨¡å‹
        async function changeModel() {
            if (!currentSessionId) return;

            const selector = document.getElementById('modelSelector');
            const newModel = selector.value;

            if (!newModel) return;

            try {
                await fetch(`/api/sessions/${currentSessionId}/model`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ model: newModel })
                });

                // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                const modelName = availableModels.find(m => m.id === newModel)?.name || newModel;
                console.log(`å·²åˆ‡æ¢åˆ°æ¨¡å‹: ${modelName}`);
            } catch (error) {
                console.error('åˆ‡æ¢æ¨¡å‹å¤±è´¥:', error);
                alert('åˆ‡æ¢æ¨¡å‹å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        }

        // å‘é€æ¶ˆæ¯
        async function sendMessage() {
            if (isGenerating || !currentSessionId) return;

            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;

            input.value = '';
            input.style.height = 'auto';
            isGenerating = true;
            updateSendButton();

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            appendMessage('user', message);

            // åˆ›å»ºåŠ©æ‰‹æ¶ˆæ¯å®¹å™¨
            const assistantMsgDiv = appendMessage('assistant', '', null, true);
            const contentDiv = assistantMsgDiv.querySelector('.message-content');

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        session_id: currentSessionId,
                        message: message
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                let fullText = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const data = line.slice(6);
                            if (data === '[DONE]') {
                                break;
                            }
                            try {
                                const json = JSON.parse(data);
                                if (json.content) {
                                    fullText += json.content;
                                    // å®æ—¶æ¸²æŸ“Markdown
                                    renderMarkdown(contentDiv, fullText);
                                    scrollToBottom();
                                } else if (json.error) {
                                    contentDiv.textContent = 'é”™è¯¯: ' + json.error;
                                }
                            } catch (e) {
                                console.error('è§£æå“åº”å¤±è´¥:', e);
                            }
                        }
                    }
                }

                // æœ€ç»ˆæ¸²æŸ“å¹¶æ·»åŠ æ—¶é—´æˆ³
                renderMarkdown(contentDiv, fullText);
                const timeDiv = document.createElement('div');
                timeDiv.className = 'message-time';
                timeDiv.textContent = new Date().toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                contentDiv.parentElement.appendChild(timeDiv);

            } catch (error) {
                contentDiv.textContent = 'å‘é€å¤±è´¥: ' + error.message;
            } finally {
                isGenerating = false;
                updateSendButton();
                await loadSessions(); // æ›´æ–°ä¼šè¯åˆ—è¡¨
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
        function appendMessage(role, content, timestamp, isStreaming = false) {
            const container = document.getElementById('messagesContainer');

            // ç§»é™¤ç©ºçŠ¶æ€
            const emptyState = container.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'ä½ ' : 'AI';

            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'message-content-wrapper';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            // ç”¨æˆ·æ¶ˆæ¯ç›´æ¥æ˜¾ç¤ºï¼ŒAIæ¶ˆæ¯æ¸²æŸ“Markdown
            if (role === 'user') {
                contentDiv.textContent = content;
            } else if (!isStreaming && content) {
                renderMarkdown(contentDiv, content);
            }

            if (timestamp && !isStreaming) {
                const timeDiv = document.createElement('div');
                timeDiv.className = 'message-time';
                timeDiv.textContent = timestamp;
                contentWrapper.appendChild(contentDiv);
                contentWrapper.appendChild(timeDiv);
            } else {
                contentWrapper.appendChild(contentDiv);
            }

            msgDiv.appendChild(avatar);
            msgDiv.appendChild(contentWrapper);
            container.appendChild(msgDiv);

            scrollToBottom();
            return msgDiv;
        }

        // æ¸²æŸ“Markdown
        function renderMarkdown(element, markdown) {
            console.log('renderMarkdown called with text length:', markdown.length);

            if (typeof marked === 'undefined') {
                console.error('Marked.js æœªå®šä¹‰ï¼Œä½¿ç”¨çº¯æ–‡æœ¬æ˜¾ç¤º');
                element.textContent = markdown;
                return;
            }

            if (!markdown || markdown.trim() === '') {
                return;
            }

            try {
                // é…ç½®marked
                marked.setOptions({
                    breaks: true,
                    gfm: true,
                    highlight: function(code, lang) {
                        if (typeof hljs === 'undefined') {
                            return code;
                        }
                        if (lang && hljs.getLanguage(lang)) {
                            try {
                                return hljs.highlight(code, { language: lang }).value;
                            } catch (e) {
                                console.error('è¯­æ³•é«˜äº®å¤±è´¥:', e);
                            }
                        }
                        return hljs.highlightAuto(code).value;
                    }
                });

                let html = marked.parse(markdown);
                console.log('Markdown parsed successfully');

                // ä¸ºä»£ç å—æ·»åŠ å¤åˆ¶æŒ‰é’®
                html = html.replace(/<pre><code class="language-(\w+)">/g, (match, lang) => {
                    return `<div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">${lang}</span>
                            <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button>
                        </div>
                        <pre><code class="language-${lang}">`;
                });

                // ä¹Ÿå¤„ç†æ²¡æœ‰è¯­è¨€æ ‡è¯†çš„ä»£ç å—
                html = html.replace(/<pre><code>/g, () => {
                    return `<div class="code-block-wrapper">
                        <div class="code-block-header">
                            <span class="code-language">code</span>
                            <button class="copy-btn" onclick="copyCode(this)">å¤åˆ¶</button>
                        </div>
                        <pre><code>`;
                });

                html = html.replace(/<\/code><\/pre>/g, '</code></pre></div>');

                element.innerHTML = html;

                // åº”ç”¨è¯­æ³•é«˜äº®
                if (typeof hljs !== 'undefined') {
                    element.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });
                }

                console.log('Markdown rendered successfully');
            } catch (e) {
                console.error('Markdownæ¸²æŸ“å¤±è´¥:', e);
                element.textContent = markdown;
            }
        }

        // å¤åˆ¶ä»£ç 
        function copyCode(button) {
            const codeBlock = button.closest('.code-block-wrapper').querySelector('code');
            const code = codeBlock.textContent;

            navigator.clipboard.writeText(code).then(() => {
                const originalText = button.textContent;
                button.textContent = 'å·²å¤åˆ¶!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶');
            });
        }

        // æ»šåŠ¨åˆ°åº•éƒ¨
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }

        // æ›´æ–°å‘é€æŒ‰é’®çŠ¶æ€
        function updateSendButton() {
            const btn = document.getElementById('sendBtn');
            const input = document.getElementById('messageInput');
            btn.disabled = isGenerating;
            btn.textContent = isGenerating ? 'ç”Ÿæˆä¸­...' : 'å‘é€';
            input.disabled = isGenerating;
        }

        // è®¾ç½®è¾“å…¥æ¡†å¤„ç†
        function setupInputHandlers() {
            const input = document.getElementById('messageInput');
            const charCounter = document.getElementById('charCounter');

            // è‡ªåŠ¨è°ƒæ•´é«˜åº¦
            input.addEventListener('input', () => {
                // é‡ç½®é«˜åº¦ä»¥è®¡ç®—æ–°çš„scrollHeight
                input.style.height = 'auto';

                // è®¾ç½®æ–°é«˜åº¦ï¼Œä½†ä¸è¶…è¿‡æœ€å¤§é«˜åº¦
                const newHeight = Math.min(input.scrollHeight, 300);
                input.style.height = newHeight + 'px';

                // æ›´æ–°å­—ç¬¦è®¡æ•°
                updateCharCounter();
            });

            // å¿«æ·é”®å¤„ç†
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // èšç„¦æ—¶æ˜¾ç¤ºå­—ç¬¦è®¡æ•°
            input.addEventListener('focus', () => {
                charCounter.classList.add('show');
            });

            input.addEventListener('blur', () => {
                if (input.value.length === 0) {
                    charCounter.classList.remove('show');
                }
            });
        }

        // æ›´æ–°å­—ç¬¦è®¡æ•°
        function updateCharCounter() {
            const input = document.getElementById('messageInput');
            const charCounter = document.getElementById('charCounter');
            const length = input.value.length;

            charCounter.textContent = `${length} å­—ç¬¦`;

            // æ ¹æ®é•¿åº¦æ”¹å˜é¢œè‰²
            charCounter.classList.remove('warning', 'error');
            if (length > 5000) {
                charCounter.classList.add('error');
            } else if (length > 3000) {
                charCounter.classList.add('warning');
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = init;
    </script>
</body>
</html>
